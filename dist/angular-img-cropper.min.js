/*! angular-img-cropper 17-05-2015 */
angular.module("angular-img-cropper",[]).directive("imageCropper",["$document","$window",function(){return{scope:{image:"=",croppedImage:"=",cropWidth:"=",cropHeight:"=",keepAspect:"=",touchRadius:"=",cropAreaBounds:"="},restrict:"A",link:function(a,b){var c,d=d||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},e=function(){function a(a,b,c){this.over=!1,this.drag=!1,this.position=new k(a,b),this.offset=new k(0,0),this.radius=c}return a.prototype.setDrag=function(a){this.drag=a,this.setOver(a)},a.prototype.draw=function(){},a.prototype.setOver=function(a){this.over=a},a.prototype.touchInBounds=function(a,b){return a>this.position.x-this.radius&&a<this.position.x+this.radius&&b>this.position.y-this.radius&&b<this.position.y+this.radius},a.prototype.getPosition=function(){return this.position},a.prototype.setPosition=function(a,b){this.position.x=a,this.position.y=b},a}(),f=function(){function a(b){this.borrowed=0,a.instance=this;for(var c=null,d=0;b>d;d++)if(0===d)this.firstAvailable=new k,c=this.firstAvailable;else{var e=new k;c.setNext(e),c=e}}return a.prototype.borrow=function(a,b){if(null==this.firstAvailable)throw"Pool exhausted";this.borrowed++;var c=this.firstAvailable;return this.firstAvailable=c.getNext(),c.x=a,c.y=b,c},a.prototype.returnPoint=function(a){this.borrowed--,a.x=0,a.y=0,a.setNext(this.firstAvailable),this.firstAvailable=a},a}(),g=function(){function a(){}return a.init=function(a){this.canvas=a,this.ctx=this.canvas.getContext("2d")},a.DEG2RAD=.0174532925,a}(),h=function(a){function b(b,c,d){a.call(this,b,c,d),this.iconPoints=new Array,this.scaledIconPoints=new Array,this.getDragIconPoints(this.iconPoints,1),this.getDragIconPoints(this.scaledIconPoints,1.2)}return d(b,a),b.prototype.draw=function(a){this.over||this.drag?this.drawIcon(a,this.scaledIconPoints):this.drawIcon(a,this.iconPoints)},b.prototype.getDragIconPoints=function(a,b){var c=17*b,d=14*b,e=8*b,g=4*b;a.push(f.instance.borrow(-g/2,c-e)),a.push(f.instance.borrow(-d/2,c-e)),a.push(f.instance.borrow(0,c)),a.push(f.instance.borrow(d/2,c-e)),a.push(f.instance.borrow(g/2,c-e)),a.push(f.instance.borrow(g/2,g/2)),a.push(f.instance.borrow(c-e,g/2)),a.push(f.instance.borrow(c-e,d/2)),a.push(f.instance.borrow(c,0)),a.push(f.instance.borrow(c-e,-d/2)),a.push(f.instance.borrow(c-e,-g/2)),a.push(f.instance.borrow(g/2,-g/2)),a.push(f.instance.borrow(g/2,-c+e)),a.push(f.instance.borrow(d/2,-c+e)),a.push(f.instance.borrow(0,-c)),a.push(f.instance.borrow(-d/2,-c+e)),a.push(f.instance.borrow(-g/2,-c+e)),a.push(f.instance.borrow(-g/2,-g/2)),a.push(f.instance.borrow(-c+e,-g/2)),a.push(f.instance.borrow(-c+e,-d/2)),a.push(f.instance.borrow(-c,0)),a.push(f.instance.borrow(-c+e,d/2)),a.push(f.instance.borrow(-c+e,g/2)),a.push(f.instance.borrow(-g/2,g/2))},b.prototype.drawIcon=function(a,b){a.beginPath(),a.moveTo(b[0].x+this.position.x,b[0].y+this.position.y);for(var c=0;c<b.length;c++){var d=b[c];a.lineTo(d.x+this.position.x,d.y+this.position.y)}a.closePath(),a.fillStyle="rgba(255,228,0,1)",a.fill()},b.prototype.recalculatePosition=function(a){var b=a.getCentre();this.setPosition(b.x,b.y),f.instance.returnPoint(b)},b}(e),i=function(a){function b(b,c,d){a.call(this,b,c,d)}return d(b,a),b.prototype.drawCornerBorder=function(a){var b=10;(this.over||this.drag)&&(b=12);var c=1,d=1;this.horizontalNeighbour.position.x<this.position.x&&(c=-1),this.verticalNeighbour.position.y<this.position.y&&(d=-1),a.beginPath(),a.lineJoin="miter",a.moveTo(this.position.x,this.position.y),a.lineTo(this.position.x+b*c,this.position.y),a.lineTo(this.position.x+b*c,this.position.y+b*d),a.lineTo(this.position.x,this.position.y+b*d),a.lineTo(this.position.x,this.position.y),a.closePath(),a.lineWidth=2,a.strokeStyle="rgba(255,228,0,1)",a.stroke()},b.prototype.drawCornerFill=function(a){var b=10;(this.over||this.drag)&&(b=12);var c=1,d=1;this.horizontalNeighbour.position.x<this.position.x&&(c=-1),this.verticalNeighbour.position.y<this.position.y&&(d=-1),a.beginPath(),a.moveTo(this.position.x,this.position.y),a.lineTo(this.position.x+b*c,this.position.y),a.lineTo(this.position.x+b*c,this.position.y+b*d),a.lineTo(this.position.x,this.position.y+b*d),a.lineTo(this.position.x,this.position.y),a.closePath(),a.fillStyle="rgba(0,0,0,1)",a.fill()},b.prototype.moveX=function(a){this.setPosition(a,this.position.y)},b.prototype.moveY=function(a){this.setPosition(this.position.x,a)},b.prototype.move=function(a,b){this.setPosition(a,b),this.verticalNeighbour.moveX(a),this.horizontalNeighbour.moveY(b)},b.prototype.addHorizontalNeighbour=function(a){this.horizontalNeighbour=a},b.prototype.addVerticalNeighbour=function(a){this.verticalNeighbour=a},b.prototype.getHorizontalNeighbour=function(){return this.horizontalNeighbour},b.prototype.getVerticalNeighbour=function(){return this.verticalNeighbour},b.prototype.draw=function(a){this.drawCornerFill(a),this.drawCornerBorder(a)},b}(e),j=function(){function a(a,b,c,d){void 0===a&&(a=0),void 0===b&&(b=0),void 0===c&&(c=0),void 0===d&&(d=0),this.left=a,this.right=a+c,this.top=b,this.bottom=b+d}return a.prototype.getWidth=function(){return this.right-this.left},a.prototype.getHeight=function(){return this.bottom-this.top},a.prototype.getCentre=function(){var a=this.getWidth(),b=this.getHeight();return f.instance.borrow(this.left+a/2,this.top+b/2)},a}(),k=function(){function a(a,b){void 0===a&&(a=0),void 0===b&&(b=0),this.x=a,this.y=b}return a.prototype.setNext=function(a){this.next=a},a.prototype.getNext=function(){return this.next},a}(),l=function(){function a(a,b,c){void 0===a&&(a=0),void 0===b&&(b=0),void 0===c&&(c=0),this.id=0,this.x=a,this.y=b,this.id=c}return a}(),m=function(){function b(a,b,c,d,e,j,k){void 0===b&&(b=0),void 0===c&&(c=0),void 0===d&&(d=100),void 0===e&&(e=50),void 0===j&&(j=!0),void 0===k&&(k=20),this.keepAspect=!1,this.aspectRatio=0,this.currentDragTouches=new Array,this.isMouseDown=!1,this.ratioW=1,this.ratioH=1,this.fileType="png",this.imageSet=!1,this.pointPool=new f(200),g.init(a),this.buffer=document.createElement("canvas"),this.cropCanvas=document.createElement("canvas"),this.buffer.width=a.width,this.buffer.height=a.height,this.tl=new i(b,c,k),this.tr=new i(b+d,c,k),this.bl=new i(b,c+e,k),this.br=new i(b+d,c+e,k),this.tl.addHorizontalNeighbour(this.tr),this.tl.addVerticalNeighbour(this.bl),this.tr.addHorizontalNeighbour(this.tl),this.tr.addVerticalNeighbour(this.br),this.bl.addHorizontalNeighbour(this.br),this.bl.addVerticalNeighbour(this.tl),this.br.addHorizontalNeighbour(this.bl),this.br.addVerticalNeighbour(this.tr),this.markers=[this.tl,this.tr,this.bl,this.br],this.center=new h(b+d/2,c+e/2,k),this.canvas=a,this.ctx=this.canvas.getContext("2d"),this.keepAspect=j,this.aspectRatio=e/d,this.draw(this.ctx),this.croppedImage=new Image,window.addEventListener("mousemove",this.onMouseMove.bind(this)),window.addEventListener("mouseup",this.onMouseUp.bind(this)),a.addEventListener("mousedown",this.onMouseDown.bind(this)),window.addEventListener("touchmove",this.onTouchMove.bind(this),!1),a.addEventListener("touchstart",this.onTouchStart.bind(this),!1),window.addEventListener("touchend",this.onTouchEnd.bind(this),!1)}return b.prototype.resizeCanvas=function(a,b){this.canvas.width=a,this.canvas.height=b,this.buffer.width=a,this.buffer.height=b,this.draw(this.ctx)},b.prototype.draw=function(a){var b=this.getBounds();if(this.srcImage){a.clearRect(0,0,this.canvasWidth,this.canvasHeight);var c=this.srcImage.height/this.srcImage.width,d=this.canvasHeight/this.canvasWidth,e=this.canvasWidth,f=this.canvasHeight;d>c?(e=this.canvasWidth,f=this.canvasWidth*c):(f=this.canvasHeight,e=this.canvasHeight/c),this.ratioW=e/this.srcImage.width,this.ratioH=f/this.srcImage.height,c>d?this.drawImageIOSFix(a,this.srcImage,0,0,this.srcImage.width,this.srcImage.height,this.buffer.width/2-e/2,0,e,f):this.drawImageIOSFix(a,this.srcImage,0,0,this.srcImage.width,this.srcImage.height,0,this.buffer.height/2-f/2,e,f),this.buffer.getContext("2d").drawImage(this.canvas,0,0,this.canvasWidth,this.canvasHeight),a.fillStyle="rgba(0, 0, 0, 0.7)",a.fillRect(0,0,this.canvasWidth,this.canvasHeight),a.drawImage(this.buffer,b.left,b.top,Math.max(b.getWidth(),1),Math.max(b.getHeight(),1),b.left,b.top,b.getWidth(),b.getHeight());for(var g,h=0;h<this.markers.length;h++)g=this.markers[h],g.draw(a);this.center.draw(a),a.lineWidth=2,a.strokeStyle="rgba(255,228,0,1)",a.strokeRect(b.left,b.top,b.getWidth(),b.getHeight())}else a.fillStyle="rgba(192,192,192,1)",a.fillRect(0,0,this.canvas.width,this.canvas.height)},b.prototype.dragCrop=function(a,b,c){var d=this.getBounds(),e=a-d.getWidth()/2,f=a+d.getWidth()/2,g=b-d.getHeight()/2,h=b+d.getHeight()/2;f>=this.maxXClamp&&(a=this.maxXClamp-d.getWidth()/2),e<=this.minXClamp&&(a=d.getWidth()/2+this.minXClamp),g<this.minYClamp&&(b=d.getHeight()/2+this.minYClamp),h>=this.maxYClamp&&(b=this.maxYClamp-d.getHeight()/2),this.tl.moveX(a-d.getWidth()/2),this.tl.moveY(b-d.getHeight()/2),this.tr.moveX(a+d.getWidth()/2),this.tr.moveY(b-d.getHeight()/2),this.bl.moveX(a-d.getWidth()/2),this.bl.moveY(b+d.getHeight()/2),this.br.moveX(a+d.getWidth()/2),this.br.moveY(b+d.getHeight()/2),c.setPosition(a,b)},b.prototype.dragCorner=function(b,c,d){var e,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0;a.keepAspect?(e=d.getHorizontalNeighbour().getVerticalNeighbour(),i=e.getPosition().x,j=e.getPosition().y,b<=e.getPosition().x?c<=e.getPosition().y?(g=i-100/this.aspectRatio,h=j-100/this.aspectRatio*this.aspectRatio,o=this.getSide(f.instance.borrow(g,h),e.getPosition(),f.instance.borrow(b,c)),o>0?(k=Math.abs(e.getPosition().y-c),l=k/this.aspectRatio,m=e.getPosition().y-k,n=e.getPosition().x-l,d.move(n,m)):0>o&&(l=Math.abs(e.getPosition().x-b),k=l*this.aspectRatio,m=e.getPosition().y-k,n=e.getPosition().x-l,d.move(n,m))):(g=i-100/this.aspectRatio,h=j+100/this.aspectRatio*this.aspectRatio,o=this.getSide(f.instance.borrow(g,h),e.getPosition(),f.instance.borrow(b,c)),o>0?(l=Math.abs(e.getPosition().x-b),k=l*this.aspectRatio,m=e.getPosition().y+k,n=e.getPosition().x-l,d.move(n,m)):0>o&&(k=Math.abs(e.getPosition().y-c),l=k/this.aspectRatio,m=e.getPosition().y+k,n=e.getPosition().x-l,d.move(n,m))):c<=e.getPosition().y?(g=i+100/this.aspectRatio,h=j-100/this.aspectRatio*this.aspectRatio,o=this.getSide(f.instance.borrow(g,h),e.getPosition(),f.instance.borrow(b,c)),0>o?(k=Math.abs(e.getPosition().y-c),l=k/this.aspectRatio,m=e.getPosition().y-k,n=e.getPosition().x+l,d.move(n,m)):o>0&&(l=Math.abs(e.getPosition().x-b),k=l*this.aspectRatio,m=e.getPosition().y-k,n=e.getPosition().x+l,d.move(n,m))):(g=i+100/this.aspectRatio,h=j+100/this.aspectRatio*this.aspectRatio,o=this.getSide(f.instance.borrow(g,h),e.getPosition(),f.instance.borrow(b,c)),0>o?(l=Math.abs(e.getPosition().x-b),k=l*this.aspectRatio,m=e.getPosition().y+k,n=e.getPosition().x+l,d.move(n,m)):o>0&&(k=Math.abs(e.getPosition().y-c),l=k/this.aspectRatio,m=e.getPosition().y+k,n=e.getPosition().x+l,d.move(n,m)))):d.move(b,c),this.center.recalculatePosition(this.getBounds())},b.prototype.getSide=function(a,b,c){var d=this.sign((b.x-a.x)*(c.y-a.y)-(b.y-a.y)*(c.x-a.x));return f.instance.returnPoint(a),f.instance.returnPoint(c),d},b.prototype.sign=function(a){return+a===a?0===a?a:a>0?1:-1:0/0},b.prototype.handleRelease=function(a){if(null!=a){for(var b=0,c=0;c<this.currentDragTouches.length;c++)a.id==this.currentDragTouches[c].id&&(this.currentDragTouches[c].dragHandle.setDrag(!1),a.dragHandle=null,b=c);this.currentDragTouches.splice(b,1),this.draw(this.ctx)}},b.prototype.handleMove=function(a){for(var b=!1,c=0;c<this.currentDragTouches.length;c++)if(a.id==this.currentDragTouches[c].id&&null!=this.currentDragTouches[c].dragHandle){var d=this.currentDragTouches[c],e=this.clampPosition(a.x-d.dragHandle.offset.x,a.y-d.dragHandle.offset.y);a.x=e.x,a.y=e.y,f.instance.returnPoint(e),d.dragHandle instanceof i?this.dragCorner(a.x,a.y,d.dragHandle):this.dragCrop(a.x,a.y,d.dragHandle),b=!0;break}if(!b){for(var g=0;g<this.markers.length;g++){var h=this.markers[g];if(h.touchInBounds(a.x,a.y)){a.dragHandle=h,this.currentDragTouches.push(a),h.setDrag(!0),a.dragHandle.offset.x=a.x-a.dragHandle.getPosition().x,a.dragHandle.offset.y=a.y-a.dragHandle.getPosition().y,this.dragCorner(a.x-a.dragHandle.offset.x,a.y-a.dragHandle.offset.y,a.dragHandle);break}}null==a.dragHandle&&this.center.touchInBounds(a.x,a.y)&&(a.dragHandle=this.center,this.currentDragTouches.push(a),a.dragHandle.setDrag(!0),a.dragHandle.offset.x=a.x-a.dragHandle.getPosition().x,a.dragHandle.offset.y=a.y-a.dragHandle.getPosition().y,this.dragCrop(a.x-a.dragHandle.offset.x,a.y-a.dragHandle.offset.y,a.dragHandle))}},b.prototype.updateClampBounds=function(){var a=this.srcImage.height/this.srcImage.width,b=this.canvas.height/this.canvas.width,c=this.canvas.width,d=this.canvas.height;b>a?(c=this.canvas.width,d=this.canvas.width*a):(d=this.canvas.height,c=this.canvas.height/a),this.minXClamp=this.canvas.width/2-c/2,this.minYClamp=this.canvas.height/2-d/2,this.maxXClamp=this.canvas.width/2+c/2,this.maxYClamp=this.canvas.height/2+d/2},b.prototype.getCropBounds=function(){var a=this.canvas.height-2*this.minYClamp,b=this.getBounds();return b.top=Math.round((a-b.top+this.minYClamp)/this.ratioH),b.bottom=Math.round((a-b.bottom+this.minYClamp)/this.ratioH),b.left=Math.round((b.left-this.minXClamp)/this.ratioW),b.right=Math.round((b.right-this.minXClamp)/this.ratioW),b},b.prototype.clampPosition=function(a,b){return a<this.minXClamp&&(a=this.minXClamp),a>this.maxXClamp&&(a=this.maxXClamp),b<this.minYClamp&&(b=this.minYClamp),b>this.maxYClamp&&(b=this.maxYClamp),f.instance.borrow(a,b)},b.prototype.isImageSet=function(){return this.imageSet},b.prototype.setImage=function(b){if(!b)throw"Image is null";this.imageSet=!0,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);var c=this.buffer.getContext("2d");c.clearRect(0,0,this.buffer.width,this.buffer.height);var d=b.src.split("."),e=d[1];("png"==e||"jpg"==e)&&(this.fileType=e),this.srcImage=b,this.updateClampBounds();var g=this.srcImage.height/this.srcImage.width,h=this.getBounds(),i=h.getHeight()/h.getWidth(),j=this.canvas.width,k=this.canvas.height;this.canvasWidth=j,this.canvasHeight=k;var l=this.canvas.width/2,m=this.canvas.height/2,n=f.instance.borrow(l-h.getWidth()/2,m+h.getHeight()/2),o=f.instance.borrow(l+h.getWidth()/2,m+h.getHeight()/2),p=f.instance.borrow(l-h.getWidth()/2,m-h.getHeight()/2),q=f.instance.borrow(l+h.getWidth()/2,m-h.getHeight()/2);if(this.tl.setPosition(n.x,n.y),this.tr.setPosition(o.x,o.y),this.bl.setPosition(p.x,p.y),this.br.setPosition(q.x,q.y),f.instance.returnPoint(n),f.instance.returnPoint(o),f.instance.returnPoint(p),f.instance.returnPoint(q),this.center.setPosition(l,m),i>g){var r=Math.min(j*g,k);if(h.getHeight()>r){var s=r/i;n=f.instance.borrow(l-s/2,m+r/2),o=f.instance.borrow(l+s/2,m+r/2),p=f.instance.borrow(l-s/2,m-r/2),q=f.instance.borrow(l+s/2,m-r/2),this.tl.setPosition(n.x,n.y),this.tr.setPosition(o.x,o.y),this.bl.setPosition(p.x,p.y),this.br.setPosition(q.x,q.y),f.instance.returnPoint(n),f.instance.returnPoint(o),f.instance.returnPoint(p),f.instance.returnPoint(q)}}else if(g>i){var t=Math.min(k/g,j);if(h.getWidth()>t){var u=t*i;n=f.instance.borrow(l-t/2,m+u/2),o=f.instance.borrow(l+t/2,m+u/2),p=f.instance.borrow(l-t/2,m-u/2),q=f.instance.borrow(l+t/2,m-u/2),this.tl.setPosition(n.x,n.y),this.tr.setPosition(o.x,o.y),this.bl.setPosition(p.x,p.y),this.br.setPosition(q.x,q.y),f.instance.returnPoint(n),f.instance.returnPoint(o),f.instance.returnPoint(p),f.instance.returnPoint(q)}}this.vertSquashRatio=this.detectVerticalSquash(b),this.draw(this.ctx);var v=this.getCroppedImage(a.cropWidth,a.cropHeight);a.croppedImage=v.src,a.cropAreaBounds&&this.imageSet&&(a.cropAreaBounds=this.getCropBounds(),a.$apply())},b.prototype.getCroppedImage=function(a,b){var c=this.getBounds();if(!this.srcImage)throw"Source image not set.";if(a&&b){var d=this.srcImage.height/this.srcImage.width,e=this.canvas.height/this.canvas.width,f=this.canvas.width,g=this.canvas.height;e>d?(f=this.canvas.width,g=this.canvas.width*d):d>e?(g=this.canvas.height,f=this.canvas.height/d):(g=this.canvas.height,f=this.canvas.width),this.ratioW=f/this.srcImage.width,this.ratioH=g/this.srcImage.height,this.cropCanvas.width=a,this.cropCanvas.height=b;var h=(this.buffer.height-g)/2/this.ratioH,i=(this.buffer.width-f)/2/this.ratioW,j=1,k=1;this.ratioW<1&&(j=this.ratioW),this.ratioH<1&&(k=this.ratioH),this.drawImageIOSFix(this.cropCanvas.getContext("2d"),this.srcImage,Math.max(Math.round(c.left/this.ratioW-i),0),Math.max(Math.round(c.top/this.ratioH-h),0),Math.max(Math.round(c.getWidth()/j),1),Math.max(Math.round(c.getHeight()/k),1),0,0,a,b),this.croppedImage.width=a,this.croppedImage.height=b}else this.cropCanvas.width=Math.max(c.getWidth(),1),this.cropCanvas.height=Math.max(c.getHeight(),1),this.cropCanvas.getContext("2d").drawImage(this.buffer,c.left,c.top,Math.max(c.getWidth(),1),Math.max(c.getHeight(),1),0,0,c.getWidth(),c.getHeight()),this.croppedImage.width=this.cropCanvas.width,this.croppedImage.height=this.cropCanvas.height;return this.croppedImage.src=this.cropCanvas.toDataURL("image/"+this.fileType),this.croppedImage},b.prototype.getBounds=function(){for(var a=Number.MAX_VALUE,b=Number.MAX_VALUE,c=-Number.MAX_VALUE,d=-Number.MAX_VALUE,e=0;e<this.markers.length;e++){var f=this.markers[e];f.getPosition().x<a&&(a=f.getPosition().x),f.getPosition().x>c&&(c=f.getPosition().x),f.getPosition().y<b&&(b=f.getPosition().y),f.getPosition().y>d&&(d=f.getPosition().y)}var g=new j;return g.left=a,g.right=c,g.top=b,g.bottom=d,g},b.prototype.getMousePos=function(a,b){var c=a.getBoundingClientRect();return f.instance.borrow(b.clientX-c.left,b.clientY-c.top)},b.prototype.getTouchPos=function(a,b){var c=a.getBoundingClientRect();return f.instance.borrow(b.clientX-c.left,b.clientY-c.top)},b.prototype.onTouchMove=function(a){if(a.preventDefault(),a.touches.length>=1)for(var b=0;b<a.touches.length;b++){var c=a.touches[b],d=this.getTouchPos(this.canvas,c),e=new l(d.x,d.y,c.identifier);f.instance.returnPoint(d),this.move(e,a)}this.draw(this.ctx)},b.prototype.onMouseMove=function(a){var b=this.getMousePos(this.canvas,a);this.move(new l(b.x,b.y,0),a);var c=this.getDragTouchForID(0);c?(c.x=b.x,c.y=b.y):c=new l(b.x,b.y,0),f.instance.returnPoint(b),this.drawCursors(c,a),this.draw(this.ctx)},b.prototype.move=function(b){this.isMouseDown&&this.handleMove(b),a.cropAreaBounds&&this.imageSet&&(a.cropAreaBounds=this.getCropBounds(),a.$apply())},b.prototype.getDragTouchForID=function(a){for(var b=0;b<this.currentDragTouches.length;b++)if(a==this.currentDragTouches[b].id)return this.currentDragTouches[b]},b.prototype.drawCursors=function(a,b){var c=!1;null!=a&&(a.dragHandle==this.center&&(this.canvas.style.cursor="move",c=!0),null!=a.dragHandle&&a.dragHandle instanceof i&&(this.drawCornerCursor(a.dragHandle,a.dragHandle.getPosition().x,a.dragHandle.getPosition().y,b),c=!0));var d=!1;if(!c){for(var e=0;e<this.markers.length;e++)d=d||this.drawCornerCursor(this.markers[e],a.x,a.y,b);if(!d){var f=b.target;f.style.cursor="initial"}}d||c||!this.center.touchInBounds(a.x,a.y)?this.center.setOver(!1):(this.center.setOver(!0),this.canvas.style.cursor="move")},b.prototype.drawCornerCursor=function(a,b,c,d){var e;return a.touchInBounds(b,c)?(a.setOver(!0),a.getHorizontalNeighbour().getPosition().x>a.getPosition().x?a.getVerticalNeighbour().getPosition().y>a.getPosition().y?(e=d.target,e.style.cursor="nwse-resize"):(e=d.target,e.style.cursor="nesw-resize"):a.getVerticalNeighbour().getPosition().y>a.getPosition().y?(e=d.target,e.style.cursor="nesw-resize"):(e=d.target,e.style.cursor="nwse-resize"),!0):(a.setOver(!1),!1)},b.prototype.onMouseDown=function(){this.isMouseDown=!0},b.prototype.onTouchStart=function(){this.isMouseDown=!0},b.prototype.onTouchEnd=function(b){for(var d=0;d<b.changedTouches.length;d++){var e=b.changedTouches[d],f=this.getDragTouchForID(e.identifier);null!=f&&((f.dragHandle instanceof i||f.dragHandle instanceof h)&&f.dragHandle.setOver(!1),this.handleRelease(f))}if(0==this.currentDragTouches.length&&(this.isMouseDown=!1),c.isImageSet()){var g=this.getCroppedImage(a.cropWidth,a.cropHeight);a.croppedImage=g.src,a.$apply()}},b.prototype.onMouseUp=function(){this.handleRelease(new l(0,0,0)),0==this.currentDragTouches.length&&(this.isMouseDown=!1)},b.prototype.drawImageIOSFix=function(a,b,c,d,e,f,g,h,i,j){a.drawImage(b,c*this.vertSquashRatio,d*this.vertSquashRatio,e*this.vertSquashRatio,f*this.vertSquashRatio,g,h,i,j)},b.prototype.detectVerticalSquash=function(a){var b=(a.naturalWidth,a.naturalHeight),c=document.createElement("canvas");c.width=1,c.height=b;var d=c.getContext("2d");d.drawImage(a,0,0);for(var e=d.getImageData(0,0,1,b).data,f=0,g=b,h=b;h>f;){var i=e[4*(h-1)+3];0===i?g=h:f=h,h=g+f>>1}var j=h/b;return 0===j?1:j},b.prototype.onMouseDown=function(){this.isMouseDown=!0},b.prototype.onMouseUp=function(){if(c.isImageSet()){this.isMouseDown=!1,this.handleRelease(new l(0,0,0));var b=this.getCroppedImage(a.cropWidth,a.cropHeight);a.croppedImage=b.src,a.$apply()}},b}();angular.element(document).ready(function(){var d=angular.element(b[0]),e=d[0],f=a.cropWidth,g=a.cropHeight,h=a.keepAspect,i=a.touchRadius;c=new m(e,e.width/2-f/2,e.height/2-g/2,f,g,h,i)}),a.$watch("image",function(b){if(null!=b){var d=new Image;d.addEventListener("load",function(){c.setImage(d);var b=c.getCroppedImage(a.cropWidth,a.cropHeight);a.croppedImage=b.src,a.$apply()},!1),d.src=b}})}}}]),angular.module("angular-img-cropper").directive("imgCropperFileread",["$timeout",function(a){return{scope:{image:"="},link:function(b,c){c.bind("change",function(c){var d=new FileReader;d.onload=function(c){a(function(){b.image=c.target.result},0)},c.target.files[0]&&d.readAsDataURL(c.target.files[0])})}}}]);